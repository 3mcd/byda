!function(a,b){b=b.bind(null,window,document),"object"==typeof exports?b(exports):"function"==typeof define&&define.amd?define([],b):a.byda=b()}(this,function(a,b){"use strict";function k(a){return"string"==typeof a?(new DOMParser).parseFromString(a,"text/html"):a}function l(a){var d,b=[],c=[];if(n(a)){d=a.querySelectorAll(m());for(var e=d.length-1;e>=0;e--)/\^$/.test(d[e].getAttribute("data-"+i))?b.push(d[e]):c.push(d[e]);return c.filter(function(a){return b.every(function(b){return!b.contains(a)})})}}function m(){return"[data-"+i+"]"}function n(a){return"object"==typeof a&&!!a.nodeType}function o(a,e){if(a){if("function"==typeof a)return a.apply(o.flash());if("string"==typeof a&&(a={file:a}),a.view&&(a.file="views/"+a.view+".html"),a.callback=e||c,a.json={req:"string"==typeof a.json?[{name:"default",file:a.json}]:a.json||[],res:{}},a.imp=f[a.file],g&&h&&!a.imp){var i=d?d+"/"+a.file:a.file,j=b.querySelector('link[href="'+i+'"]');if(j)return a.imp=j["import"],p(a);var k=b.createElement("link");k.rel="import",k.href=i,k.onload=function(){a.imp=k["import"],p(a)},k.onerror=function(){r(a)},b.head.appendChild(k)}else p(a)}}function p(a){var b,e=a.json.req[0],f=e?e.file:a.file;if(!f||a.imp)return q(null,a);g&&g.readyState<4&&(g.onreadystatechange=c,g.abort());var g=new XMLHttpRequest;f=d?d+"/"+f:f,g.open("GET",f,!0),g.setRequestHeader("X-BYDA","true"),g.onreadystatechange=function(){if(4==g.readyState)if(e&&a.json.req.splice(0,1),200==g.status||0===g.status&&-1!=f.indexOf("file:///")){var c=g.responseText;if(!e)return q(c,a);b=JSON.parse(c),"default"==e.name?a.json.res=b:a.json.res[e.name]=b,p(a)}else e&&p(a),r(a)},g.send()}function q(a,b){var c=f[b.file]||o.flash({dom:a||b.imp});f[b.file]=c,setTimeout(function(){o.flash({dom:b.dom,transitions:b.transitions}).generate(c).run(function(){b.callback.apply(this.update(),[b.json.res])},function(){j(b)})},0)}function r(a){throw new Error("Could not get: "+a.file)}function s(a,b,c){this.name=a,this.list=[],this.transition=c,this.value=b}function t(a){a||(a={}),this.dom=k(a.dom)||b,this.list=l(this.dom),this.transitions=a.transitions||{},a.frozen&&(this.frozen=!0),this.organize()}var d,g,c=function(){},e={},f={},h="import"in b.createElement("link"),i="load",j=c;return s.prototype.emit=function(){var c,d={detail:{name:this.name,value:this.value},bubbles:!0,cancelable:!0};"function"==typeof CustomEvent?c=new CustomEvent("byda",d):b.createEvent&&(c=b.createEvent("CustomEvent"),c.initCustomEvent("byda",d.bubbles,d.cancelable,d.detail)),a.dispatchEvent(c)},s.prototype.set=function(a){var c,d;for("object"==typeof a&&(a=a[this.name]),a||(a=""),c=this.list.length-1;c>=0;c--)d=this.list[c],"value"in d?d.value=a:d.innerHTML=a;return this.value=a,this.emit(),this},s.prototype.get=function(){return this.value},s.prototype.compare=function(a){return"object"==typeof a&&(this.to=a.list[0]),this},s.prototype.commit=function(a){function c(){return d&&b.set(d),f&&f.parentNode&&f.parentNode.removeChild(f),a&&a(b.name)}var b=this;if(!this.to)return c();var f,g,d=n(this.to)?this.to.value||this.to.innerHTML:this.to,e=this.list;if(d||(d=""),"function"==typeof this.transition)for(var h=e.length-1;h>=0;h--)f=e[h],g=f.cloneNode(!0),f.setAttribute("data-"+i,"^"),g.innerHTML=d,this.transition(f,g,c);else c()},t.prototype.update=function(){return this.organize(l(this.dom))},t.prototype.count=function(){var a=0;for(var b in this.stores)a++;return a},t.prototype.find=function(a){return this.stores[a]},t.prototype.map=function(a){for(var c in a)this.stores[c]&&this.stores[c].set(a[c]);return this},t.prototype.condense=function(){var a={},b=this.stores;for(var c in b)a[c]=b[c].get();return a},t.prototype.generate=function(a){for(var b in this.stores)this.stores[b].compare(a.stores[b]);return this},t.prototype.organize=function(a){var b,c,d,f=this.stores={};for(a&&(this.list=a),b=this.list.length-1;b>=0;b--)c=this.list[b],d=c.getAttribute("data-"+i),this.frozen&&(c=c.cloneNode(!0)),f[d]||(f[d]=new s(d,c.value||c.innerHTML,this.transitions[d]||e[d])),f[d].list.push(c);return this},t.prototype.run=function(a,b){function e(a){return d.push(a),c==d.length?b&&b():void 0}var c=this.count(),d=[];for(var f in this.stores)this.stores[f].commit(e);"function"==typeof a&&a.apply(this)},o.init=function(a){a&&(i="string"==typeof a?a:a.data||i,e=a.transitions||e,g=a.imports,d=a.base,j=a.complete||c)},o.base=function(a){return"string"==typeof a&&(d=a),d},o.flash=function(a){return new t(a)},o});